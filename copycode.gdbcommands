# load native .so which contains code for copycode()
set $soaddr = (void*) dlopen("./copycode.so", 2)
add-symbol-file "./copycode.so" $soaddr

# get address of fread()
set $freadaddr = (char*) &'guest_func_fread'

# patch noopfunc call to flush
set $flushaddr= $freadaddr + 218
# clflush
print *($flushaddr + 0) = 0x0f
print *($flushaddr + 1) = 0xae
print *($flushaddr + 2) = 0x3d
# rip relative disp
print *($flushaddr + 3) = 0x09
print *($flushaddr + 4) = 0x00
print *($flushaddr + 5) = 0x00
print *($flushaddr + 6) = 0x00
# padding
print *($flushaddr + 7) = 0x90
print *($flushaddr + 8) = 0x90
print *($flushaddr + 9) = 0x90

# get address of target function
set $targetaddr = (void*)((uint64_t)$freadaddr ^ (1 << 25))

# call copycode with appropriate arguments
print (int) copycode($targetaddr, $freadaddr, 0x100)

# ensure result was 0
if $1 != 0
print "!!!!!!! Error performing copycode !!!!!!!"
end

# patch fread call in wasm indirect function table to use the copied version
set $functable = (char*) &'guest_table_0'
set $functablerow = (char**)($functable + (1 << 4) + 0x8)
p *($functablerow) = $targetaddr
