
#define _GNU_SOURCE
#include <stdlib.h>
#include <stdio.h>
#include <dlfcn.h>
#include <errno.h>
#include <string.h>
#include <stdint.h>

#include <sys/types.h>
#include <unistd.h>
#include <sys/mman.h>

#include <sys/stat.h>
#include <fcntl.h>
#include <stddef.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/ioctl.h>


#define COOL_DEVICE_NAME "cool"
#define COOL_DEVICE_PATH "/dev/" COOL_DEVICE_NAME

#define COOL_IOCTL_MAGIC_NUMBER (long)0xc31

#define COOL_IOCTL_CMD_BTBF _IOR(COOL_IOCTL_MAGIC_NUMBER, 1, size_t)

#define CHECK(x) if (!(x)) { abort(); }

#define UP 0
#define DOWN 1
uint64_t roundVal(uint64_t numToRound, uint64_t multiple, uint64_t roundDirection)
{
    if (multiple == 0)
        return numToRound;

    uint64_t remainder = numToRound % multiple;
    if (remainder == 0)
        return numToRound;

    if (roundDirection == UP) {
        return numToRound + multiple - remainder;
    } else {
        return numToRound - remainder;
    }
}


int copycode(void* dest_address, const void* src_address, const unsigned int size)
{
    char* aligned_dest_start = (char*) roundVal((uint64_t) dest_address, 4096, DOWN);
    char* aligned_dest_end = (char*) roundVal((uint64_t) dest_address + size, 4096, UP);
    const unsigned int map_size = aligned_dest_end - aligned_dest_start;

    void* mapped = mmap(aligned_dest_start, map_size, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANONYMOUS | MAP_PRIVATE | MAP_FIXED, -1, 0);
    if(mapped == MAP_FAILED) {
        printf("Mmap failed: %s\n", strerror(errno));
        return -1;
    }
    printf("mapped: (%p, %p)\n", mapped, (void*)((char*)mapped + map_size));
    memcpy(dest_address, src_address, size);
    printf("copied: (%p, %p)\n", dest_address, (void*)((char*)dest_address + size));
    return 0;
}

int btbf = -1;

void btb_flush() {
    if(btbf < 0) {
        btbf = open(COOL_DEVICE_PATH, 0);
        if(btbf < 0) {
            printf("Can't find btb flush device.\nPlease insmod cool.ko first.\n");
            abort();
        }
    }
    if(ioctl(btbf, COOL_IOCTL_CMD_BTBF, 0) < 0) {
        printf("Failed to execute ibpb.\n");
        abort();
    }
}

int main(int argc, char const *argv[])
{
    btb_flush();
}
