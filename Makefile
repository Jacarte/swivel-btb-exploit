CC=gcc
WAT2WASM=wat2wasm
LUCETC=$(LUCET_SRC)/target/release/lucetc
BINDINGS=$(SAFE_SIDE)/build-lucet/bindings.json
LUCETC_ARGS= --guard-size 4GiB --min-reserved-size 4GiB --max-reserved-size 4GiB

.PHONY: all
all: btb.so copycode.so btb_oop.so

btb.wasm: btb.wat
	$(WAT2WASM) $< -o $@

btb.so: btb.wasm
	$(LUCETC) --bindings $(BINDINGS) $(LUCETC_ARGS) --pinned-heap-reg $< -o $@

breakout.so: breakout.c
	gcc $< o $<.
	$(LUCETC) --bindings $(BINDINGS) $(LUCETC_ARGS) --pinned-heap-reg -o $@

btb_oop.wasm: oop/btb.wat
	$(WAT2WASM) $< -o $@

btb_oop.so: btb_oop.wasm
	$(LUCETC) --bindings $(BINDINGS) $(LUCETC_ARGS) $< -o $@

copycode.so: copycode.c
	$(CC) -fPIC -shared $< -o $@

.PHONY: run
run: btb.so copycode.so gdb.sh
	./gdb.sh

.PHONY: clean
clean:
	-rm btb.wasm
	-rm btb.so
	-rm copycode.so
	-rm btb_oop.wasm
	-rm btb_oop.so
