CC=gcc
WAT2WASM=../wabt-1.0.19-ubuntu/wabt-1.0.19/bin/wat2wasm
LUCETC=../lucet-spectre-repro/target/release/lucetc
BINDINGS=../safeside/build-lucet/bindings.json
LUCETC_ARGS= --guard-size 4GiB --min-reserved-size 4GiB --max-reserved-size 4GiB

stock/%:
loadlfence/%: LUCETC_ARGS += --spectre-mitigation=loadlfence
strawman/%: LUCETC_ARGS += --spectre-mitigation=strawman
sfi_full/%: LUCETC_ARGS += --spectre-mitigation=sfi
sfi_aslr/%: LUCETC_ARGS += --spectre-mitigation=sfiaslr
cet_full/%: LUCETC_ARGS += --spectre-mitigation=cet
cet_aslr/%: LUCETC_ARGS += --spectre-mitigation=cetaslr

SONAMES=btb_breakout.so btb_leakage.so

.PHONY: all
all:  $(addprefix stock/, $(SONAMES)) \
		copycode.so

.PRECIOUS:%.wasm

btb_breakout.wasm: 
	# Select from the random pool
	# $(WAT2WASM) btb_breakout.wat -o $@
	# Copy and paste the script below to evaluate different seeds
	bash get_random_wasm.sh breakout_pool btb_breakout.wasm breakout.stack.16807.wasm.1000.wasm
	# Do a single pass with stacking when the needed avg is calculated

btb_leakage.wasm: 
	# Select from the random pool
	# $(WAT2WASM) btb_leakage.wat -o $@
	# Copy and paste the script below to evaluate different seeds
	bash get_random_wasm.sh leakage_pool btb_leakage.wasm leakage.stack.16807.wasm.1000.wasm
	# Do a single pass with stacking when the needed avg is calculated

%/btb_leakage.so: btb_leakage.wasm
	mkdir -p $(dir $@)
	$(LUCETC) --bindings $(BINDINGS) $(LUCETC_ARGS) --pinned-heap-reg $< -o $@

%/btb_breakout.so: btb_breakout.wasm
	mkdir -p $(dir $@)
	$(LUCETC) --bindings $(BINDINGS) $(LUCETC_ARGS) $< -o $@

copycode.so: copycode.c
	$(CC) -fPIC -shared $< -o $@

.PHONY: clean
clean:
	-rm *.wasm
	-rm *.so
	-rm -rf stock
	-rm -rf loadlfence
	-rm -rf strawman
	-rm -rf sfi_full
	-rm -rf sfi_aslr
	-rm -rf cet_full
	-rm -rf cet_aslr
