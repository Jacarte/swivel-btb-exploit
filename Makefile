CC=gcc
WAT2WASM=wat2wasm
LUCETC=$(LUCET_SRC)/target/release/lucetc
BINDINGS=$(SAFE_SIDE)/build-lucet/bindings.json
LUCETC_ARGS= --guard-size 4GiB --min-reserved-size 4GiB --max-reserved-size 4GiB

stock/%:
loadlfence/%: LUCETC_ARGS += --spectre-mitigation=loadlfence
strawman/%: LUCETC_ARGS += --spectre-mitigation=strawman
sfi_full/%: LUCETC_ARGS += --spectre-mitigation=sfi
sfi_aslr/%: LUCETC_ARGS += --spectre-mitigation=sfiaslr
cet_full/%: LUCETC_ARGS += --spectre-mitigation=cet
cet_aslr/%: LUCETC_ARGS += --spectre-mitigation=cetaslr

SONAMES=btb_leakage.so btb_breakout.so

.PHONY: all
all:  $(addprefix stock/, $(SONAMES)) \
			$(addprefix loadlfence/, $(SONAMES)) \
			$(addprefix strawman/, $(SONAMES)) \
			$(addprefix sfi_full/, $(SONAMES)) \
			$(addprefix sfi_aslr/, $(SONAMES)) \
			$(addprefix cet_full/, $(SONAMES)) \
			$(addprefix cet_aslr/, $(SONAMES)) \
			copycode.so

%.wasm: %.wat
	$(WAT2WASM) $< -o $@

%/btb_leakage.so: btb_leakage.wasm
	mkdir -p $(dir $@)
	$(LUCETC) --bindings $(BINDINGS) $(LUCETC_ARGS) --pinned-heap-reg $< -o $@

%/btb_breakout.so: btb_breakout.wasm
	mkdir -p $(dir $@)
	$(LUCETC) --bindings $(BINDINGS) $(LUCETC_ARGS) $< -o $@

copycode.so: copycode.c
	$(CC) -fPIC -shared $< -o $@

.PHONY: clean
clean:
	-rm *.wasm
	-rm *.so
	-rm -rf stock
	-rm -rf loadlfence
	-rm -rf strawman
	-rm -rf sfi_full
	-rm -rf sfi_aslr
	-rm -rf cet_full
	-rm -rf cet_aslr
